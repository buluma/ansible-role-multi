---
- name: Print the gateway for each host when defined
  ansible.builtin.debug:
    msg: System {{ inventory_hostname }} has gateway {{ ansible_default_ipv4.gateway }}
  when: ansible_default_ipv4.gateway is defined

- name: Display all variables/facts known for a host
  ansible.builtin.debug:
    var: hostvars[inventory_hostname]
    verbosity: 4

- name: Show configured default become user
  debug: msg="{{ lookup('config', 'DEFAULT_BECOME_USER')}}"

- name: print out role paths
  debug:
    msg: "These are the configured role paths: {{lookup('config', 'DEFAULT_ROLES_PATH')}}"

- name: find retry files, skip if missing that key
  find:
    paths: "{{lookup('config', 'RETRY_FILES_SAVE_PATH')|default(playbook_dir, True)}}"
    patterns: "*.retry"

- name: see the colors
  debug: msg="{{item}}"
  loop: "{{lookup('config', 'COLOR_OK', 'COLOR_CHANGED', 'COLOR_SKIP', wantlist=True)}}"

- name: show remote user and port for ssh connection
  debug: msg={{q("config", "remote_user", "port", plugin_type="connection", plugin_name="ssh", on_missing='skip')}}

- name: show remote_tmp setting for shell (sh) plugin
  debug: msg={{q("config", "remote_tmp", plugin_type="shell", plugin_name="sh")}}

- name: Ensure a job that runs at 2 and 5 exists. Creates an entry like "0 5,2 * * ls -alh > /dev/null"
  ansible.builtin.cron:
    name: "check dirs"
    minute: "0"
    hour: "5,2"
    job: "ls -alh > /dev/null"

- name: Install iptables packages (Ubuntu)
  action: apt pkg={{item}} update_cache=yes
  with_items:
    - iptables
    - iptables-persistent
  tags: iptables

- name: Collect only selected facts
  ansible.builtin.setup:
    filter:
      - 'ansible_distribution'
      - 'ansible_machine_id'
      - 'ansible_*_mb'

- name: install required software
  ansible.builtin.package:
    name: "{{ users_requirements }}"
    state: present

- name: loop over users_group_list
  ansible.builtin.include_tasks:
    file: group.yml
  loop: "{{ users_group_list }}"
  loop_control:
    label: "{{ group.name }}"
    loop_var: group
  when:
    - users_group_list is defined

- name: loop over users_user_list
  ansible.builtin.include_tasks:
    file: user.yml
  loop: "{{ users_user_list }}"
  loop_control:
    label: "{{ user.name }}"
    loop_var: user
  when:
    - users_user_list is defined

- name: manage cron permission
  ansible.builtin.template:
    src: cron.allow.j2
    dest: /etc/cron.allow
    mode: "0644"
  when:
    - users_cron_allow | bool

- name: check existence of /etc/cron.allow
  ansible.builtin.file:
    path: /etc/cron.allow
    state: absent
  when:
    - not users_cron_allow | bool
